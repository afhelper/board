<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QnA ê´€ë¦¬ì í˜ì´ì§€</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 max-w-2xl">

        <div id="loginSection" class="bg-white p-8 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold mb-6 text-center">QnA ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="ì´ë©”ì¼"
                    class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸"
                    class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="loginButton"
                    class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600">ë¡œê·¸ì¸</button>
            </div>
            <p id="loginError" class="text-red-500 text-center mt-4"></p>
        </div>

        <div id="contentSection" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="suggestionsCount" class="text-xl font-bold"></h2>
                <button id="logoutButton"
                    class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div id="suggestionsList" class="space-y-4"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getFirestore, collection, query, orderBy, doc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBeIPr1H_de7eIZUagNAUvPbw-rYRteP9U",
            authDomain: "submit-33eb1.firebaseapp.com",
            projectId: "submit-33eb1",
            storageBucket: "submit-33eb1.appspot.com",
            messagingSenderId: "123176179541",
            appId: "1:123176179541:web:c40f2392c8b95fb93601dc"
        };

        // Firebase ì•± ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();
        const ADMIN_EMAILS = ["goback@gif.com", "super_admin@admin.com"];

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const loginSection = document.getElementById('loginSection');
        const contentSection = document.getElementById('contentSection');
        const suggestionsList = document.getElementById('suggestionsList');
        const suggestionsCountElement = document.getElementById('suggestionsCount');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('loginError');

        let unsubscribe = null; // onSnapshot ë¦¬ìŠ¤ë„ˆë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ë³€ìˆ˜

        // --- ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ (í•µì‹¬ ë¡œì§) ---
        // --- ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ (í•µì‹¬ ë¡œì§) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•œ ê²½ìš°
                loginSection.classList.add('hidden');
                contentSection.classList.remove('hidden');

                const isAdmin = ADMIN_EMAILS.includes(user.email);

                // ì´ì „ ë¦¬ìŠ¤ë„ˆê°€ ìˆë‹¤ë©´ ì¤‘ì§€
                if (unsubscribe) {
                    unsubscribe();
                }
                // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                listenForSuggestions(isAdmin);

            } else {
                // ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒí•œ ê²½ìš°

                // ğŸ’¡ğŸ’¡ğŸ’¡ í•µì‹¬ ìˆ˜ì • ë¶€ë¶„ ì‹œì‘ ğŸ’¡ğŸ’¡ğŸ’¡
                console.log("ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒë¨. ë¦¬ìŠ¤ë„ˆë¥¼ ë¨¼ì € í•´ì œí•©ë‹ˆë‹¤.");

                // 1. ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆë¶€í„° í™•ì‹¤í•˜ê²Œ í•´ì œí•œë‹¤.
                if (unsubscribe) {
                    unsubscribe();
                    unsubscribe = null;
                }

                // 2. ê·¸ ë‹¤ìŒì— í™”ë©´ UIë¥¼ ë³€ê²½í•œë‹¤.
                loginSection.classList.remove('hidden');
                contentSection.classList.add('hidden');
                suggestionsList.innerHTML = ''; // ëª©ë¡ ì´ˆê¸°í™”
                suggestionsCountElement.textContent = ''; // ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
                // ğŸ’¡ğŸ’¡ğŸ’¡ í•µì‹¬ ìˆ˜ì • ë¶€ë¶„ ë ğŸ’¡ğŸ’¡ğŸ’¡
            }
        });




        // --- ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ---
        loginButton.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            loginError.textContent = ''; // ì´ì „ ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”

            if (!email || !password) {
                loginError.textContent = "ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // ë¡œê·¸ì¸ì€ onAuthStateChangedê°€ ê°ì§€í•´ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„  ë³„ë„ ì‘ì—… í•„ìš” ì—†ìŒ
            } catch (error) {
                console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                loginError.textContent = "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.";
            }
        });

        // --- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ---
        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });


        // admin.html íŒŒì¼ì—ì„œ ìˆ˜ì •í•´ì•¼ í•  ë¶€ë¶„
        function listenForSuggestions(isAdmin) { // isAdmin íŒŒë¼ë¯¸í„°ëŠ” ë” ì´ìƒ í•„ìš” ì—†ìŒ
            const q = query(collection(db, 'suggestions2'), orderBy('timestamp', 'desc'));

            unsubscribe = onSnapshot(q, (querySnapshot) => {
                suggestionsList.innerHTML = '';
                suggestionsCountElement.textContent = `ì´ ${querySnapshot.size}ê°œ QnA`;

                // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ UIDë¥¼ ê°€ì ¸ì™€ì„œ ê´€ë¦¬ìì¸ì§€ ë‹¤ì‹œ í™•ì¸
                const currentUser = auth.currentUser;
                const currentIsAdmin = currentUser && ADMIN_EMAILS.includes(currentUser.email); // ì—¬ê¸°ì„œ ë‹¤ì‹œ isAdminì„ ê³„ì‚°

                if (querySnapshot.empty) {
                    suggestionsList.innerHTML = '<p class="text-gray-500 text-center">í˜„ì¬ QnAê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const suggestionData = doc.data();
                        // ìƒˆë¡œ ê³„ì‚°ëœ currentIsAdmin ê°’ì„ ì „ë‹¬
                        const suggestionElement = createSuggestionElement(suggestionData, doc.id, currentIsAdmin);
                        suggestionsList.appendChild(suggestionElement);
                    });
                }
            }, (error) => {
                console.error("ê±´ì˜ ëª©ë¡ ì‹¤ì‹œê°„ ë¡œë”© ì‹¤íŒ¨:", error);
                showError("ê±´ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        }



        // --- ê±´ì˜ì‚¬í•­ ìš”ì†Œ ìƒì„± í•¨ìˆ˜ ---
        function createSuggestionElement(data, docId, isAdmin) {
            const element = document.createElement('div');
            element.className = 'bg-white shadow-md rounded-lg p-4';

            // ê´€ë¦¬ìì¼ ê²½ìš°ì—ë§Œ ì‚­ì œ ë²„íŠ¼ HTML ìƒì„±
            const deleteButtonHtml = isAdmin
                ? `<button onclick="deleteSuggestion('${docId}')" class="ml-4 bg-red-500 text-white px-3 py-1 rounded">ì‚­ì œ</button>`
                : '';

            element.innerHTML = `
                <p class="text-lg mb-2">${escapeHtml(data.content)}</p>
                <div class="flex justify-end items-center">
                    <span class="text-sm text-gray-500">${formatTimestamp(data.timestamp.toDate())}</span>
                    ${deleteButtonHtml}
                </div>
            `;
            return element;
        }

        // --- ì „ì—­ ì‚­ì œ í•¨ìˆ˜ ---
        window.deleteSuggestion = async function (docId) {
            if (!confirm("ì •ë§ë¡œ ì´ ê±´ì˜ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                await deleteDoc(doc(db, 'suggestions2', docId));
                console.log("ê±´ì˜ì‚¬í•­ ì‚­ì œ ì„±ê³µ");
                // ì‚­ì œ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ì´ í•„ìš” ì—†ìŒ! onSnapshotì´ ìë™ìœ¼ë¡œ ê°ì§€í•´ì„œ ì²˜ë¦¬í•´ì¤Œ.
            } catch (error) {
                console.error("ê±´ì˜ì‚¬í•­ ì‚­ì œ ì‹¤íŒ¨:", error);
                showError("ê±´ì˜ì‚¬í•­ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        };

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ---
        function formatTimestamp(date) {
            return date.toLocaleString('ko-KR');
        }

        function escapeHtml(unsafe) {
            return unsafe.replace(/[&<"']/g, m => ({ '&': '&amp;', '<': '&lt;', '"': '&quot;', "'": '&#039;' }[m]));
        }

        function showError(message) {
            const errorElement = document.createElement('div');
            errorElement.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4';
            errorElement.innerHTML = message;
            contentSection.insertBefore(errorElement, suggestionsList);
            setTimeout(() => errorElement.remove(), 5000);
        }
    </script>
</body>

</html>