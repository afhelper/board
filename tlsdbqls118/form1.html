<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>to ìœ ë°±ğŸ’–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .h-screen {
            height: 100vh;
            /* ê¸°ë³¸ì ìœ¼ë¡œ 100vh ì‚¬ìš© */
            height: 100dvh !important;
            /* dvh ì§€ì› ë¸Œë¼ìš°ì €ì—ì„œëŠ” dvh ì‚¬ìš© */
            /* touch-action: manipulation; */
        }

        /* ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen bg-gray-100 h-screen">
    <div class="w-full max-w-md p-8 space-y-2 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-center text-gray-700">to ìœ ë°±ğŸ’–</h2>

        <!-- ì´ë¯¸ì§€ ê³µê°„ -->
        <div class="flex justify-center">
            <img src="./1058686692652dc43.jpeg" alt="ì²¨ë¶€ ì´ë¯¸ì§€" class="w-full bg-gray-200 rounded-md object-cover">
        </div>

        <form id="suggestionForm">
            <div class="space-y-4">
                <div>
                    <textarea id="suggestion" rows="4" maxlength="200"
                        class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 200ì)" required></textarea>
                </div>
            </div>

            <div class="flex items-center justify-between mt-2">
                <button type="submit"
                    class="submit-button w-full px-4 py-2 font-medium text-white bg-blue-500 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 relative">
                    <span class="button-text">ì œì¶œí•˜ê¸°</span>
                    <span class="spinner hidden"></span> <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
                </button>
            </div>
        </form>
    </div>

    <script type="module">
        console.log("ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘");

        // Firebase SDKë¥¼ ëª¨ë“ˆë¡œ import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        // onAuthStateChangedë¥¼ ì¶”ê°€ë¡œ import
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
        console.log("Firebase ëª¨ë“ˆ ì„í¬íŠ¸ ì™„ë£Œ");

        const firebaseConfig = {
            apiKey: "AIzaSyBeIPr1H_de7eIZUagNAUvPbw-rYRteP9U",
            authDomain: "submit-33eb1.firebaseapp.com",
            projectId: "submit-33eb1",
            storageBucket: "submit-33eb1.appspot.com",
            messagingSenderId: "123176179541",
            appId: "1:123176179541:web:c40f2392c8b95fb93601dc"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        console.log("Firebase ì´ˆê¸°í™” ì™„ë£Œ");

        // --- ì¸ì¦ ì²˜ë¦¬ë¥¼ ìœ„í•œ ìƒˆë¡œìš´ í•¨ìˆ˜ ---
        const getAuthenticatedUser = () => {
            return new Promise((resolve, reject) => {
                // onAuthStateChangedëŠ” ì¸ì¦ ìƒíƒœê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ í˜¸ì¶œë˜ì§€ë§Œ,
                // í•œë²ˆë§Œ í˜¸ì¶œí•´ì„œ í˜„ì¬ ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ unsubscribeë¥¼ ì‚¬ìš©í•œë‹¤.
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    unsubscribe(); // ì²« ìƒíƒœë¥¼ ë°›ì€ í›„ ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°í•˜ì—¬ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
                    if (user) {
                        // ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì(ê´€ë¦¬ì ë˜ëŠ” ì´ì „ ìµëª… ì‚¬ìš©ì)ê°€ ìˆìœ¼ë©´ ë°˜í™˜
                        console.log("ê¸°ì¡´ ì‚¬ìš©ì í™•ì¸:", user.uid);
                        resolve(user);
                    } else {
                        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ìµëª…ìœ¼ë¡œ ë¡œê·¸ì¸
                        console.log("ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì—†ìŒ. ìµëª… ë¡œê·¸ì¸ ì‹œë„.");
                        signInAnonymously(auth)
                            .then(userCredential => {
                                console.log("ìƒˆë¡œìš´ ìµëª… ì‚¬ìš©ì ë¡œê·¸ì¸ ì„±ê³µ:", userCredential.user.uid);
                                resolve(userCredential.user);
                            })
                            .catch(error => {
                                console.error("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                                reject(error);
                            });
                    }
                }, (error) => {
                    // onAuthStateChanged ìì²´ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•œ ê²½ìš°
                    console.error("onAuthStateChanged ì—ëŸ¬:", error);
                    unsubscribe();
                    reject(error);
                });
            });
        };

        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì •
        document.getElementById('suggestionForm').addEventListener('submit', async (e) => {
            console.log("í¼ ì œì¶œ ì´ë²¤íŠ¸ ë°œìƒ");
            e.preventDefault();

            const submitButton = e.target.querySelector('button[type="submit"]');
            const spinner = submitButton.querySelector('.spinner');
            const buttonText = submitButton.querySelector('.button-text');

            submitButton.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.classList.add('hidden');

            const suggestion = document.getElementById('suggestion').value;

            try {
                // 1. ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ê°€ì¥ ë¨¼ì € ì‹¤í–‰)
                const user = await getAuthenticatedUser();
                const userIdentifier = user.uid;
                console.log("ì‚¬ìš©ì ì‹ë³„ì:", userIdentifier);

                // 2. ë§ˆì§€ë§‰ ì œì¶œ ì‹œê°„ í™•ì¸
                const q = query(
                    collection(db, 'suggestions2'),
                    where('userIdentifier', '==', userIdentifier),
                    orderBy('timestamp', 'desc'),
                    limit(1)
                );
                const querySnapshot = await getDocs(q);
                const now = new Date();

                if (!querySnapshot.empty) {
                    const lastSubmissionTimestamp = querySnapshot.docs[0].data().timestamp.toDate();
                    if ((now - lastSubmissionTimestamp) < (5 * 60 * 1000)) { // 5ë¶„ ì¿¨ë‹¤ìš´
                        console.log("5ë¶„ ë‚´ ì¬ì œì¶œ ì‹œë„");
                        alert('5ë¶„ ì´ë‚´ì—ëŠ” í•œ ë²ˆë§Œ ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        // finally ë¸”ë¡ì„ ì‹¤í–‰ì‹œí‚¤ê¸° ìœ„í•´ ì—¬ê¸°ì„œ return.
                        // returnì„ í•´ë„ finallyëŠ” í•­ìƒ ì‹¤í–‰ëœë‹¤.
                        return;
                    }
                }

                // 3. Firestoreì— ë°ì´í„° ì €ì¥
                console.log("Firestoreì— ì €ì¥ ì‹œë„:", {
                    content: suggestion,
                    timestamp: serverTimestamp(),
                    userIdentifier: userIdentifier
                });

                await addDoc(collection(db, 'suggestions2'), {
                    content: suggestion,
                    timestamp: serverTimestamp(),
                    userIdentifier: userIdentifier
                });

                console.log("ë¬¸ì„œ ì €ì¥ ì™„ë£Œ.");
                alert('ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('suggestion').value = '';

            } catch (error) {
                console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                // try ë¸”ë¡ì—ì„œ returnì„ í•˜ë”ë¼ë„ ì´ ë¶€ë¶„ì€ ì‹¤í–‰ëœë‹¤.
                submitButton.disabled = false;
                spinner.classList.add('hidden');
                buttonText.classList.remove('hidden');
            }
        });

        console.log("ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì™„ë£Œ");
    </script>
</body>

</html>