<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>확인 페이지</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f4f8;
            font-family: 'Inter', sans-serif;
            margin: 0;
        }

        .suggestion-container {
            width: 600px;
            height: 460px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .suggestion-index {
            font-size: 1.5rem;
            color: #555555;
            position: absolute;
            top: 1rem;
            width: 100%;
            text-align: center;
        }

        .suggestion-content {
            font-size: 2rem;
            color: #333333;
            margin-bottom: 1.5rem;
            max-height: calc(100% - 6rem);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .suggestion-timestamp {
            font-size: 0.875rem;
            color: #888888;
            position: absolute;
            bottom: 1rem;
            width: 100%;
            text-align: center;
        }

        .button-container {
            position: absolute;
            bottom: 3rem;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 1rem;
        }

        .next-button,
        .prev-button {
            background-color: #007bff;
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .tts-button {
            background-color: #cccccc;
            color: #ffffff;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.25rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
        }

        .next-button:hover,
        .prev-button:hover,
        .tts-button:hover {
            background-color: #0056b3;
        }

        .tts-button:hover {
            background-color: #5a6268;
        }

        .next-button:disabled,
        .prev-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div class="suggestion-container">
        <div id="suggestionIndex" class="suggestion-index"></div>
        <div id="suggestionContent" class="suggestion-content mx-5"></div>
        <div id="suggestionTimestamp" class="suggestion-timestamp"></div>
        <div class="button-container">
            <button id="prevButton" class="prev-button" disabled>이전</button>
            <button id="ttsButton" class="tts-button">
                <i class="fas fa-volume-up"></i>
            </button>
            <button id="nextButton" class="next-button">다음</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

        // --- 유틸리티 함수: 디바운싱 ---
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        const firebaseConfig = {
            apiKey: "AIzaSyBeIPr1H_de7eIZUagNAUvPbw-rYRteP9U",
            authDomain: "submit-33eb1.firebaseapp.com",
            projectId: "submit-33eb1",
            storageBucket: "submit-33eb1.appspot.com",
            messagingSenderId: "123176179541",
            appId: "1:123176179541:web:c40f2392c8b95fb93601dc"
        };

        const GOOGLE_TTS_API_KEY = "";
        const GOOGLE_TTS_API_URL = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_API_KEY}`;

        // 오디오 재생을 관리할 변수
        let currentAudio = null; // 현재 Audio 객체를 저장
        let isSpeaking = false;  // 재생 상태 (재생중 true, 정지/일시정지 false)

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        signInAnonymously(auth).then(() => {
            console.log("익명 사용자로 로그인 성공");

            const suggestionIndex = document.getElementById('suggestionIndex');
            const suggestionContent = document.getElementById('suggestionContent');
            const suggestionTimestamp = document.getElementById('suggestionTimestamp');
            const nextButton = document.getElementById('nextButton');
            const prevButton = document.getElementById('prevButton');
            const ttsButton = document.getElementById('ttsButton');
            const ttsButtonIcon = ttsButton.querySelector('i');

            // 아이콘을 '일시정지' 모양으로 변경
            function setPauseIcon() {
                ttsButtonIcon.classList.remove('fa-volume-up');
                ttsButtonIcon.classList.add('fa-pause');
            }

            // 아이콘을 '재생' 모양으로 변경
            function setPlayIcon() {
                ttsButtonIcon.classList.remove('fa-pause');
                ttsButtonIcon.classList.add('fa-volume-up');
            }

            // 재생 중인 오디오를 중지하고 상태를 초기화하는 함수
            function stopCurrentAudio() {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                isSpeaking = false;
                setPlayIcon();
            }

            // 현재 제안 내용을 음성으로 읽어주는 함수 (Google TTS 사용)
            async function speakCurrentSuggestion() {
                stopCurrentAudio(); // 이전 오디오가 있다면 중지

                let textToRead = suggestionContent.textContent;
                if (!textToRead) return;

                if (textToRead.startsWith('@')) {
                    textToRead = textToRead.substring(1);
                }

                try {
                    const response = await fetch(GOOGLE_TTS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            input: { text: textToRead },
                            voice: { languageCode: 'ko-KR', name: 'ko-KR-Standard-A' },
                            audioConfig: { audioEncoding: 'MP3' }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`TTS API Error: ${response.statusText}`);
                    }

                    const data = await response.json();
                    if (data.audioContent) {
                        currentAudio = new Audio(`data:audio/mp3;base64,${data.audioContent}`);

                        currentAudio.onplay = () => {
                            isSpeaking = true;
                            setPauseIcon();
                        };

                        currentAudio.onpause = () => {
                            isSpeaking = false;
                            setPlayIcon();
                        };

                        currentAudio.onended = () => {
                            stopCurrentAudio();
                        };

                        currentAudio.play();
                    }
                } catch (error) {
                    console.error("Google TTS 음성 변환 중 오류 발생:", error);
                    stopCurrentAudio();
                }
            }

            const debouncedSpeak = debounce(speakCurrentSuggestion, 200);

            // [수정] 버튼 상태를 제외하고 화면 내용만 업데이트하는 함수
            function displaySuggestion(index, suggestionsArray, totalSuggestions) {
                if (index >= 0 && index < totalSuggestions) {
                    suggestionIndex.textContent = `${index + 1}/${totalSuggestions}`;
                    suggestionContent.textContent = suggestionsArray[index].content;
                    suggestionTimestamp.textContent = `제출 시간: ${suggestionsArray[index].timestamp}`;

                    if (suggestionsArray[index].content.length > 120) {
                        suggestionContent.style.fontSize = '1.5rem';
                    } else {
                        suggestionContent.style.fontSize = '2rem';
                    }
                }
            }

            async function loadSuggestions() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'suggestions'));
                    const suggestionsArray = [];
                    querySnapshot.forEach((doc) => {
                        const suggestionData = doc.data();
                        suggestionsArray.push({
                            content: suggestionData.content,
                            timestamp: suggestionData.timestamp.toDate()
                        });
                    });

                    suggestionsArray.sort((a, b) => a.timestamp - b.timestamp);
                    suggestionsArray.forEach(suggestion => {
                        suggestion.timestamp = formatTimestamp(suggestion.timestamp);
                    });

                    let currentIndex = -1; // [수정] 시작 인덱스를 -1로 설정 (초기 안내 화면)
                    const totalSuggestions = suggestionsArray.length;

                    // [추가] 화면과 버튼 상태를 업데이트하는 통합 함수
                    // 화면과 버튼 상태를 업데이트하는 통합 함수
                    function updateView() {
                        stopCurrentAudio();

                        if (currentIndex === -1) {
                            // 초기 안내 화면 표시
                            suggestionIndex.textContent = '';
                            suggestionContent.textContent = "준비가 되면 '다음' 버튼을 눌러주세요.";
                            suggestionTimestamp.textContent = '';
                            suggestionContent.style.fontSize = '2rem';

                            // [수정] '이전' 버튼과 'TTS' 버튼 숨기기
                            prevButton.style.display = 'none';
                            ttsButton.style.display = 'none';
                        } else {
                            // [수정] '이전' 버튼과 'TTS' 버튼 다시 보이게 하기
                            prevButton.style.display = '';
                            ttsButton.style.display = '';

                            // 제안 내용 표시
                            displaySuggestion(currentIndex, suggestionsArray, totalSuggestions);
                            ttsButton.disabled = false;
                            debouncedSpeak();
                        }

                        // 버튼 활성화/비활성화 상태 관리
                        prevButton.disabled = currentIndex <= 0; // 첫번째(0) 항목일 때 '이전' 비활성화
                        nextButton.disabled = currentIndex >= totalSuggestions - 1;
                    }
                    // [수정] 초기 화면 표시
                    updateView();

                    nextButton.addEventListener('click', () => {
                        currentIndex++;
                        updateView();
                    });

                    prevButton.addEventListener('click', () => {
                        currentIndex--;
                        updateView();
                    });

                    ttsButton.addEventListener('click', () => {
                        if (!suggestionContent.textContent) return;

                        if (currentAudio && !currentAudio.ended) {
                            if (isSpeaking) {
                                currentAudio.pause();
                            } else {
                                currentAudio.play();
                            }
                        } else {
                            speakCurrentSuggestion();
                        }
                    });

                } catch (error) {
                    console.error("목록을 가져오는 중 오류 발생:", error);
                    suggestionContent.textContent = "목록을 가져오는 중 오류가 발생했습니다.";
                }
            }

            loadSuggestions();
        }).catch((error) => {
            console.error("익명 사용자로 로그인 중 오류 발생:", error);
        });

        function formatTimestamp(date) {
            let year = date.getFullYear().toString();
            let month = String(date.getMonth() + 1).padStart(2, '0');
            let day = String(date.getDate()).padStart(2, '0');
            let hours = String(date.getHours()).padStart(2, '0');
            let minutes = String(date.getMinutes()).padStart(2, '0');
            let seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    </script>

</body>

</html>