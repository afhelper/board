<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ì˜¤íƒ± & ì•™ì²´ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .h-screen {
            height: 100vh;
            /* ê¸°ë³¸ì ìœ¼ë¡œ 100vh ì‚¬ìš© */
            height: 100dvh !important;
            /* dvh ì§€ì› ë¸Œë¼ìš°ì €ì—ì„œëŠ” dvh ì‚¬ìš© */
            /* touch-action: manipulation; */
        }

        /* ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* í”Œë ˆì´ìŠ¤í™€ë” ìŠ¤íƒ€ì¼ */
        select:required:invalid {
            color: gray;
        }

        option[value=""][disabled] {
            display: none;
        }

        option {
            color: black;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen bg-gray-100 h-screen">
    <div class="w-full max-w-md p-8 space-y-2 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-center text-gray-700">ğŸ¤«ğŸ’­ìµëª… QnAğŸ’­ğŸ¤«</h2>

        <div class="flex justify-center">
            <img src="./KakaoTalk_Photo_2025-07-13-19-10-43.jpeg" alt="ì²¨ë¶€ ì´ë¯¸ì§€"
                class="w-full bg-gray-200 rounded-md object-cover">
        </div>

        <form id="suggestionForm">
            <div class="space-y-4">
                <div>
                    <select id="memberSelect" required
                        class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="" disabled selected>ë©¤ë²„ ì„ íƒ</option>
                        <option value="ëª¨ë‘ì—ê²Œ">ëª¨ë‘ì—ê²Œ</option>
                        <option value="ë¯¸ì˜¤íƒ±">ë¯¸ì˜¤íƒ±</option>
                        <option value="ì•™ì²´ë¦¬">ì•™ì²´ë¦¬</option>
                    </select>
                </div>
                <div>
                    <textarea id="suggestion" rows="4" maxlength="200"
                        class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 200ì)" required></textarea>
                </div>
            </div>

            <div class="flex items-center justify-between mt-2">
                <button type="submit"
                    class="submit-button w-full px-4 py-2 font-medium text-white bg-blue-500 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 relative">
                    <span class="button-text">ì œì¶œí•˜ê¸°</span>
                    <span class="spinner hidden"></span> </button>
            </div>
        </form>
    </div>

    <script type="module">
        console.log("ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘");

        // Firebase SDKë¥¼ ëª¨ë“ˆë¡œ import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
        console.log("Firebase ëª¨ë“ˆ ì„í¬íŠ¸ ì™„ë£Œ");

        const firebaseConfig = {
            apiKey: "AIzaSyBeIPr1H_de7eIZUagNAUvPbw-rYRteP9U",
            authDomain: "submit-33eb1.firebaseapp.com",
            projectId: "submit-33eb1",
            storageBucket: "submit-33eb1.appspot.com",
            messagingSenderId: "123176179541",
            appId: "1:123176179541:web:c40f2392c8b95fb93601dc"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        console.log("Firebase ì´ˆê¸°í™” ì™„ë£Œ");

        async function getUserIdentifier() {
            console.log("getUserIdentifier í•¨ìˆ˜ í˜¸ì¶œ");
            try {
                const auth = getAuth();
                const userCredential = await signInAnonymously(auth);
                const uid = userCredential.user.uid;
                console.log("ì‚¬ìš©ì uid:", uid);
                return uid;
            } catch (error) {
                console.error("ì‚¬ìš©ì ì‹ë³„ì ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", error);
                return "unknown";
            }
        }

        async function getLastSubmission(userIdentifier) {
            console.log("getLastSubmission í•¨ìˆ˜ í˜¸ì¶œ", userIdentifier);
            try {
                const q = query(
                    collection(db, 'suggestions'),
                    where('userIdentifier', '==', userIdentifier),
                    orderBy('timestamp', 'desc'),
                    limit(1)
                );
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    console.log("ë§ˆì§€ë§‰ ì œì¶œ ì‹œê°„ ì°¾ìŒ");
                    const lastSubmissionData = querySnapshot.docs[0].data();
                    const lastSubmissionTimestamp = lastSubmissionData.timestamp.toDate();
                    return lastSubmissionTimestamp;
                }
                console.log("ì´ì „ ì œì¶œ ì—†ìŒ");
                return null;
            } catch (error) {
                console.error("ë§ˆì§€ë§‰ ì œì¶œ ì‹œê°„ í™•ì¸ ì˜¤ë¥˜:", error);
                return null;
            }
        }

        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì •
        document.getElementById('suggestionForm').addEventListener('submit', async (e) => {
            console.log("í¼ ì œì¶œ ì´ë²¤íŠ¸ ë°œìƒ");
            e.preventDefault();

            const submitButton = e.target.querySelector('button[type="submit"]');
            const spinner = submitButton.querySelector('.spinner');
            const buttonText = submitButton.querySelector('.button-text');

            const memberSelect = document.getElementById('memberSelect'); // ë©¤ë²„ ì„ íƒ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            const selectedMember = memberSelect.value; // ì„ íƒëœ ë©¤ë²„ ê°’ ê°€ì ¸ì˜¤ê¸°
            const suggestionText = document.getElementById('suggestion').value; // ë©”ì‹œì§€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°

            // ë©¤ë²„ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸ (í”Œë ˆì´ìŠ¤í™€ë” ê°’ì¸ì§€ í™•ì¸)
            if (!selectedMember) {
                alert('ë©¤ë²„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return; // ì œì¶œ ì¤‘ë‹¨
            }

            submitButton.disabled = true;  // ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™”
            spinner.classList.remove('hidden');  // ìŠ¤í”¼ë„ˆ í‘œì‹œ
            buttonText.classList.add('hidden');  // í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°

            // ìµœì¢… ì œì¶œë  í…ìŠ¤íŠ¸ ìƒì„± (@ë©¤ë²„ì´ë¦„ + ë©”ì‹œì§€)
            const finalSuggestion = `@${selectedMember}\n${suggestionText}`;

            try {
                const userIdentifier = await getUserIdentifier();
                console.log("ì‚¬ìš©ì ì‹ë³„ì:", userIdentifier);

                const lastSubmission = await getLastSubmission(userIdentifier);
                const now = new Date();

                if (lastSubmission && (now - lastSubmission) < (5 * 60 * 1000)) {
                    console.log("5ë¶„ ë‚´ ì¬ì œì¶œ ì‹œë„");
                    alert('5ë¶„ ë‚´ ì¤‘ë³µì œì¶œ ë¶ˆê°€');
                    submitButton.disabled = false;  // ì œì¶œ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                    spinner.classList.add('hidden');  // ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
                    buttonText.classList.remove('hidden');  // í…ìŠ¤íŠ¸ ë³µêµ¬
                    return;
                }

                console.log("Firestoreì— ì €ì¥ ì‹œë„:", {
                    content: finalSuggestion, // ìˆ˜ì •ëœ ë‚´ìš©ìœ¼ë¡œ ì €ì¥
                    timestamp: serverTimestamp(),
                    userIdentifier: userIdentifier
                });

                const docRef = await addDoc(collection(db, 'suggestions'), {
                    content: finalSuggestion, // ìˆ˜ì •ëœ ë‚´ìš©ìœ¼ë¡œ ì €ì¥
                    timestamp: serverTimestamp(),
                    userIdentifier: userIdentifier
                });

                console.log("ë¬¸ì„œ ì €ì¥ ì™„ë£Œ. ë¬¸ì„œ ID:", docRef.id);
                alert('ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('suggestion').value = ''; // ë©”ì‹œì§€ ì…ë ¥ì°½ ë¹„ìš°ê¸°
                memberSelect.value = ''; // ë“œë¡­ë‹¤ìš´ ì„ íƒ ì´ˆê¸°í™” (í”Œë ˆì´ìŠ¤í™€ë”ë¡œ)
            } catch (error) {
                console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                submitButton.disabled = false;  // ì œì¶œ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                spinner.classList.add('hidden');  // ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
                buttonText.classList.remove('hidden');  // í…ìŠ¤íŠ¸ ë³µêµ¬
            }
        });

        console.log("ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì™„ë£Œ");
    </script>
</body>

</html>